<Window x:Class="DuplicateFinder.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:DuplicateFinder"
        xmlns:b="clr-namespace:DuplicateFinder.Behaviors"
        xmlns:c="clr-namespace:DuplicateFinder.Converters"
        xmlns:i="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"
        mc:Ignorable="d"
        Title="Duplikaty" Height="600" Width="1200" FontSize="14">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="VisibleIfTrueConverter" />
        <c:BooleanToColorConverter x:Key="HiglightedBrushConverter" TrueBrush="LightYellow" FalseBrush="Transparent" />
        <c:BooleanToTextDecorationConverter x:Key="FileExistsToStrikeoutConverter" TrueDecoration="{x:Null}" FalseDecoration="{x:Static TextDecorations.Strikethrough}" />

        
    </Window.Resources>

    <Grid VerticalAlignment="Stretch">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="5*"/>
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Row="0" Grid.ColumnSpan="3" Orientation="Horizontal" >
            <Button Margin="5" Content="Skanuj foldery" Command="{Binding NewScan, Mode=OneTime}" />
            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" />
            <TextBlock Margin="5" Text="Typ szukania:" />
            <ComboBox Margin="5" Width="120" SelectedIndex="{Binding DuplicateSelectionType}" >
                <ComboBoxItem Content="Nazwa pliku"/>
                <ComboBoxItem Content="MD5"/>
                <ComboBoxItem Content="Nazwa + MD5"/>
            </ComboBox>
            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" />
            <CheckBox Margin="5" Content="Pokazuj tylko duplikaty" IsChecked="{Binding ShowOnlyDuplicated}" VerticalAlignment="Center" />
            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" />
        </StackPanel>

        <TreeView x:Name="treeView" Grid.Row="1" Grid.Column="0" ItemsSource="{Binding FileStructure}" VerticalAlignment="Stretch" 
                  VirtualizingStackPanel.VirtualizationMode="Recycling" >
            <i:Interaction.Triggers>
                <i:EventTrigger EventName="SelectedItemChanged">
                    <i:InvokeCommandAction Command="{Binding FileSelected}" CommandParameter="{Binding ElementName=treeView, Path=SelectedItem}"/>
                </i:EventTrigger>
                <i:EventTrigger EventName="MouseDoubleClick">
                    <i:InvokeCommandAction Command="{Binding OpenNode}" CommandParameter="{Binding ElementName=treeView, Path=SelectedItem}"/>
                </i:EventTrigger>
            </i:Interaction.Triggers>
            <TreeView.ItemContainerStyle>
                <Style TargetType="{x:Type TreeViewItem}">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                    <!--<Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />-->
                    <Setter Property="Visibility" Value="Visible" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsVisible}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </TreeView.ItemContainerStyle>
            <TreeView.Resources>
                <HierarchicalDataTemplate ItemsSource="{Binding Children}" DataType="{x:Type local:DirectoryItemVm}">
                    <StackPanel Orientation="Horizontal" ToolTip="{Binding FullPath, Mode=OneTime}" >

                        <StackPanel.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Pokaż" Command="{Binding OpenNode, Mode=OneTime}" />
                            </ContextMenu>
                        </StackPanel.ContextMenu>

                        <TextBlock Text="{Binding Name, Mode=OneTime}" />
                        <TextBlock Text="&#x26A0;" Foreground="DarkOrange" Margin="5, 0" Visibility="{Binding HasDuplicates, Mode=OneWay, Converter={StaticResource VisibleIfTrueConverter}}" />
                    </StackPanel>
                </HierarchicalDataTemplate>
                <HierarchicalDataTemplate ItemsSource="{Binding Children}" DataType="{x:Type local:FileItemVm}">
                    <StackPanel Orientation="Horizontal" ToolTip="{Binding FullPath, Mode=OneTime}" >

                        <StackPanel.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Pokaż" Command="{Binding OpenNode, Mode=OneTime}" />
                            </ContextMenu>
                        </StackPanel.ContextMenu>

                        <Image Source="{Binding Icon, Mode=OneTime}" Height="16" Width="16" Margin="2" />
                        <TextBlock Text="{Binding Name, Mode=OneTime}" TextDecorations="{Binding FileExists, Mode=OneWay,Converter={StaticResource FileExistsToStrikeoutConverter}}" />
                        <TextBlock Text="{Binding DuplicateCount, StringFormat=({0}) }" Foreground="DarkRed" FontWeight="Bold" Margin="5, 0" Visibility="{Binding HasDuplicates, Mode=OneWay, Converter={StaticResource VisibleIfTrueConverter}}" />
                    </StackPanel>
                </HierarchicalDataTemplate>
            </TreeView.Resources>
        </TreeView>

        <GridSplitter Grid.Row="1" Grid.Column="1"  Width="5" HorizontalAlignment="Stretch" />

        <ListView Grid.Row="1" Grid.Column="2" ItemsSource="{Binding Duplicates}" HorizontalContentAlignment="Stretch" 
            VirtualizingStackPanel.VirtualizationMode="Recycling" >
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Border HorizontalAlignment="Stretch" BorderBrush="LightGray" BorderThickness="1"
                            Background="{Binding IsHiglighted, Mode=OneWay, Converter={StaticResource HiglightedBrushConverter}}" >
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="40" SharedSizeGroup="col0" />
                                <ColumnDefinition Width="auto" SharedSizeGroup="col1" />
                                <ColumnDefinition Width="auto" SharedSizeGroup="col2" />
                                <ColumnDefinition Width="*" SharedSizeGroup="spacer" />
                                <ColumnDefinition Width="90" SharedSizeGroup="col3" />
                                <ColumnDefinition Width="90" SharedSizeGroup="col4" />
                            </Grid.ColumnDefinitions>

                            <Image Grid.Row="0" Grid.RowSpan="2" Grid.Column="0" Source="{Binding Icon, Mode=OneTime}" Margin="5" />

                            <TextBlock Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="3" Margin="5" TextWrapping="WrapWithOverflow" HorizontalAlignment="Stretch" Text="{Binding Path, Mode=OneTime}" FontWeight="Bold" TextDecorations="{Binding FileExists, Mode=OneWay,Converter={StaticResource FileExistsToStrikeoutConverter}}" />
                            <TextBlock Grid.Row="1" Grid.Column="1" Margin="5" Text="{Binding FileLastAccessDate, Mode=OneWay}" Foreground="Gray" Visibility="{Binding FileExists, Mode=OneWay, Converter={StaticResource VisibleIfTrueConverter}}"/>
                            <TextBlock Grid.Row="1" Grid.Column="2" Margin="5" Text="{Binding Md5, Mode=OneWay}" Foreground="Gray" Visibility="{Binding FileExists, Mode=OneWay, Converter={StaticResource VisibleIfTrueConverter}}"/>

                            <Button Grid.Column="4" Grid.RowSpan="2" Content="Otwórz" Margin="5" Width="80" Command="{Binding Open, Mode=OneTime}" Visibility="{Binding FileExists, Mode=OneWay, Converter={StaticResource VisibleIfTrueConverter}}" />
                            <Button Grid.Column="5" Grid.RowSpan="2" Content="Usuń" Margin="5" Width="80" Command="{Binding Delete, Mode=OneTime}" Visibility="{Binding FileExists, Mode=OneWay, Converter={StaticResource VisibleIfTrueConverter}}" />

                        </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListView>

    </Grid>
</Window>
